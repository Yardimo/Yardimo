<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Yardimo ‚Ä¢ Map Draw (Mobile‚ÄëFirst v4)</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet"/>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" rel="stylesheet"/>
<style>
  :root{--panel:#0f1720;--muted:#1c2633;--text:#eaf2f6;--sub:#b8c5cf;--brand:#2dd4bf;--warn:#ffd447;--danger:#f87171}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#0b0f14;color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a,button,input,select{font:inherit}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  header .nav{display:flex;justify-content:space-between;align-items:center;gap:8px}
  header nav a{color:var(--sub);text-decoration:none;margin-left:10px}
  .btn{background:#16202b;border:1px solid var(--muted);color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#05221d;border-color:transparent;font-weight:600}
  .btn.danger{background:#2a1616;color:#fee;border-color:#512}
  .btn:active{transform:translateY(1px)}
  .seg{display:inline-flex;border:1px solid var(--muted);border-radius:999px;overflow:hidden}
  .seg button{padding:10px 14px;background:transparent;border:0;color:var(--sub);cursor:pointer}
  .seg button.active{background:var(--brand);color:#05221d}

  /* Map area */
  #map{height:70vh;border:1px solid var(--muted);border-radius:16px;overflow:hidden;position:relative}
  #map, .mapboxgl-canvas{touch-action:manipulation}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .stack{display:grid;gap:8px}
  .list{margin-top:8px;border:1px solid var(--muted);border-radius:12px;max-height:240px;overflow:auto}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #12202c}
  .list-item:last-child{border-bottom:0}
  .badge{border:1px solid var(--muted);padding:8px 10px;border-radius:10px;background:#0e141c;color:var(--sub)}
  .hint{font-size:12px;color:var(--sub);margin-left:8px}

  /* Floating draw HUD */
  .draw-hud{position:fixed;left:0;right:0;bottom:0;z-index:10;padding:10px;display:none}
  .draw-hud .box{max-width:700px;margin:0 auto;background:rgba(11,15,20,.92);border:1px solid var(--muted);backdrop-filter:blur(6px);border-radius:16px;padding:10px;display:flex;align-items:center;gap:8px}
  .draw-hud .box .meta{flex:1;color:var(--sub);font-size:14px}
  .draw-hud .box .meta b{color:var(--text)}
  .draw-hud .box .actions{display:flex;gap:8px}
  .draw-hud .ghost{font-size:12px;color:var(--sub)}

  /* Thumb‚Äëfriendly */
  .thumb-row{display:flex;gap:8px}
  .thumb-row .btn{padding:14px 16px;min-width:44px;min-height:44px}

  select,input{background:#0b0f14;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:10px}

  .bottomBar{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(15,23,32,.1),rgba(15,23,32,.9));backdrop-filter:blur(6px);padding:12px;border-top:1px solid var(--muted);border-radius:0 0 16px 16px}

  @media (max-width:980px){
    .hint{display:none}
    .wrap{padding:10px}
    header nav{display:none}
  }
</style>
</head>
<body>
<header>
  <div class="wrap nav">
    <a href="index.html" class="btn" style="padding:6px 10px">üè∑Ô∏è Yardimo</a>
    <nav>
      <a href="index.html" style="color:#fff">Quotes</a>
      <a href="jobs.html">Jobs</a>
      <a href="crew.html">Crew</a>
      <a href="customers.html">Customers</a>
      <a href="pricing.html">Pricing</a>
      <a href="settings.html">Settings</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="panel">
    <h2>Draw & Quote</h2>
    <div class="toolbar" style="justify-content:space-between;align-items:center">
      <div class="seg" role="tablist" aria-label="Service type">
        <button id="modeLawn" class="active" aria-pressed="true">Lawn Care</button>
        <button id="modeSnow" aria-pressed="false">Snow Removal</button>
      </div>
      <span class="hint">Tap to add points. Double‚Äëtap or press <b>Finish</b> to end.</span>
    </div>

    <div id="geocoder" class="toolbar"></div>
    <div id="map"></div>

    <div class="toolbar thumb-row" aria-label="Drawing tools">
      <div class="seg" aria-label="Draw">
        <button id="btnArea">Add Area</button>
        <button id="btnEdge">Add Edge</button>
      </div>
      <button class="btn" id="btnUndo" title="Undo last or delete selected">Undo</button>
      <button class="btn danger" id="btnDelete" title="Delete selected">Delete</button>
      <label style="margin-left:auto;display:flex;gap:8px;align-items:center">
        Label
        <select id="labelSelect">
          <option value="">(none)</option>
          <option>Front Yard</option>
          <option>Back Yard</option>
          <option>Side Yard</option>
          <option>Driveway</option>
          <option>Walkway</option>
          <option>Sidewalk</option>
          <option>Parking Lot</option>
          <option>Other</option>
        </select>
      </label>
    </div>

    <div class="metrics thumb-row">
      <span class="badge">Area: <b id="area">0</b> sqft</span>
      <span class="badge">Linear: <b id="linear">0</b> m</span>
      <span class="badge">Quote: <b id="total">$0.00</b></span>
    </div>

    <div class="stack" style="margin-top:10px">
      <div id="pricingLawn" class="stack">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label>Base $ <input id="baseLawn" type="number" step="0.01" value="15"></label>
          <label>$ / sqft lawn <input id="rateLawnSqft" type="number" step="0.0001" value="0.008"></label>
          <label>$ / m drive <input id="rateDriveM" type="number" step="0.01" value="0.8"></label>
        </div>
      </div>
      <div id="pricingSnow" class="stack" style="display:none">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label>Base $ <input id="baseSnow" type="number" step="0.01" value="25"></label>
          <label>$ / sqft lot <input id="rateLotSqft" type="number" step="0.0001" value="0.010"></label>
          <label>$ / m sidewalk <input id="rateSidewalkM" type="number" step="0.01" value="1.2"></label>
        </div>
      </div>
    </div>

    <div class="list" id="shapeList" aria-live="polite"></div>

    <div class="bottomBar">
      <div class="row" style="justify-content:flex-end">
        <button id="saveContinue" class="btn primary">Save & Continue</button>
      </div>
    </div>
  </section>
</main>

<!-- Floating Draw HUD (mobile first) -->
<div class="draw-hud" id="drawHud" aria-live="polite">
  <div class="box">
    <div class="meta">
      <div><b id="hudMode">Drawing‚Ä¶</b> <span class="ghost" id="hudHint">Tap to add points.</span></div>
      <div class="ghost">Pts: <span id="hudPts">0</span> ‚Ä¢ <span id="hudMeasure">0</span></div>
    </div>
    <div class="actions">
      <button class="btn" id="btnFinish">Finish</button>
      <button class="btn danger" id="btnCancel">Cancel</button>
    </div>
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== CONFIG =====
mapboxgl.accessToken = 'pk.eyJ1IjoibWlrZW5vcnJpcyIsImEiOiJjbWU0eXIyMHQwb3NlMm1wcHNkYXRwYzYxIn0.HrNdh-cFPgqR4SSYgkdHTw';
const SUPABASE_URL = 'https://yikxwceipqtxjarcnxdr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlpa3h3Y2VpcHF0eGphcmNueGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NzkyMTIsImV4cCI6MjA3MDM1NTIxMn0.PmvRyNucXrOMXcwsXIWAaK6pfia0bzEXUw53cHEhFqI';
const ACCOUNT_ID = '0c3c69de-450c-4b76-91a7-cdc70d64ec9d';

// ===== UTIL =====
const $ = id => document.getElementById(id);
const fmt = n => (Math.round(n*100)/100).toLocaleString();
const vib = ms => ('vibrate' in navigator) && navigator.vibrate(ms);
let ACTIVE_DRAW = null; // 'draw_polygon' | 'draw_line_string' | null

// ===== MAP =====
const map = new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/mapbox/satellite-streets-v12',
  center:[-81.2497, 42.9836], // London, ON
  zoom:16, pitch:0, bearing:0
});
map.addControl(new mapboxgl.NavigationControl({showCompass:false}));
map.on('load', ()=> map.resize());

// Reduce accidental rotations (major clunky source on mobile)
map.dragRotate.disable();
map.touchZoomRotate.disableRotation();

// User location button
map.addControl(new mapboxgl.GeolocateControl({
  positionOptions: { enableHighAccuracy: true },
  showUserLocation: true,
  trackUserLocation: false
}));

// Geocoder (autocomplete)
const geocoder = new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  mapboxgl, marker:false, placeholder:'Search address',
  flyTo: {zoom:19, speed:0.8}, countries:'ca,us'
});
$('geocoder').appendChild(geocoder.onAdd(map));

gocoder.on('result', e => {
  const [lon,lat] = e.result.center;
  map.flyTo({center:[lon,lat], zoom:19});
});

// ===== DRAW =====
const Draw = new MapboxDraw({
  displayControlsDefault:false,
  styles:[
    // Polygons
    {id:'gl-draw-polygon-fill', type:'fill', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{'fill-color':'#2dd4bf','fill-opacity':0.22}},
    {id:'gl-draw-polygon-stroke-active', type:'line', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{'line-color':'#2dd4bf','line-width':3}},
    // Lines
    {id:'gl-draw-line', type:'line', filter:['all',['==','$type','LineString'],['!=','mode','static']], paint:{'line-color':'#ffd447','line-width':4}},
    // Easier-to-hit vertices
    {id:'gl-draw-points-halo', type:'circle', filter:['all',['==','$type','Point'],['!=','meta','midpoint'],['!=','mode','static']], paint:{'circle-radius':10,'circle-color':'#000','circle-opacity':0.25}},
    {id:'gl-draw-points', type:'circle', filter:['all',['==','$type','Point'],['!=','meta','midpoint'],['!=','mode','static']], paint:{'circle-radius':6,'circle-color':'#2dd4bf','circle-stroke-color':'#05221d','circle-stroke-width':2}},
    {id:'gl-draw-midpoint', type:'circle', filter:['all',['==','$type','Point'],['==','meta','midpoint']], paint:{'circle-radius':6,'circle-color':'#ffd447','circle-stroke-color':'#1c2633','circle-stroke-width':2}}
  ]
});
map.addControl(Draw);

function setMapGestures(enabled){
  map[enabled?'dragPan.enable':'dragPan.disable']();
  map[enabled?'scrollZoom.enable':'scrollZoom.disable']();
  map[enabled?'boxZoom.enable':'boxZoom.disable']();
  map[enabled?'keyboard.enable':'keyboard.disable']();
  // Toggle double-tap zoom so our dblclick-to-finish works while drawing
  map[enabled?'doubleClickZoom.enable':'doubleClickZoom.disable']();
}

$('btnArea').onclick = ()=> startDraw('draw_polygon');
$('btnEdge').onclick = ()=> startDraw('draw_line_string');
$('btnFinish').onclick = ()=> finishDraw();
$('btnCancel').onclick = ()=> cancelDraw();
$('btnUndo').onclick = ()=>{
  const ids = Draw.getSelectedIds();
  if(ids.length){ Draw.trash(); }
  else {
    const all = Draw.getAll().features; if(all.length){ Draw.delete(all[all.length-1].id);} }
  recalc();
};
$('btnDelete').onclick = ()=>{ const s=Draw.getSelectedIds(); if(s.length){ Draw.delete(s); recalc(); } };

function startDraw(mode){
  ACTIVE_DRAW = mode;
  Draw.changeMode(mode);
}

function finishDraw(){
  Draw.changeMode('simple_select');
  ACTIVE_DRAW = null;
  setDrawingHUD(false);
  setMapGestures(true);
  vib(10);
}

function cancelDraw(){
  // If user cancels mid-draw, try to remove an incomplete geometry
  const all = Draw.getAll().features;
  const last = all[all.length-1];
  if(last){
    const t = last.geometry.type;
    const coords = t==='Polygon' ? (last.geometry.coordinates?.[0]||[]) : (last.geometry.coordinates||[]);
    const min = t==='Polygon'?3:2;
    if(coords.length < min){ Draw.delete(last.id); }
  }
  Draw.changeMode('simple_select');
  ACTIVE_DRAW = null;
  setDrawingHUD(false);
  setMapGestures(true);
}

// Show HUD + lock gestures while drawing
map.on('draw.modechange', e => {
  const m = e.mode; ACTIVE_DRAW = (m==='draw_polygon' || m==='draw_line_string') ? m : null;
  const drawing = !!ACTIVE_DRAW;
  setDrawingHUD(drawing, m==='draw_polygon' ? 'Drawing Area' : 'Drawing Edge');
  setMapGestures(!drawing);
  if(drawing){ $('hudHint').textContent = 'Tap to add points ¬∑ Double‚Äëtap or press Finish'; }
});

function setDrawingHUD(active,label){
  $('drawHud').style.display = active ? 'block' : 'none';
  if(active){ $('hudMode').textContent = label || 'Drawing‚Ä¶'; }
}

// Double-tap anywhere on the map to finish while drawing
$('map').addEventListener('dblclick', () => {
  if(ACTIVE_DRAW) finishDraw();
}, {passive:true});

// Live HUD measures while drawing
map.on('mousemove', updateHUD);
map.on('click', updateHUD);
function updateHUD(){
  if(!ACTIVE_DRAW) return;
  const fc = Draw.getAll();
  const last = fc.features[fc.features.length-1];
  if(!last) return;
  const isPoly = last.geometry.type==='Polygon';
  const coords = isPoly ? (last.geometry.coordinates?.[0]||[]) : (last.geometry.coordinates||[]);
  $('hudPts').textContent = coords.length;
  let measure = 0;
  if(isPoly){ measure = turf.area(last)*10.7639; $('hudMeasure').textContent = fmt(measure)+' sqft'; }
  else { measure = turf.length(last,{units:'kilometers'})*1000; $('hudMeasure').textContent = fmt(measure)+' m'; }
}

// Label selected feature
$('labelSelect').addEventListener('change', () => {
  const sel = Draw.getSelected(); if(!sel.features.length) return;
  const f = sel.features[0]; f.properties = f.properties || {}; f.properties.label = $('labelSelect').value || '';
  Draw.add(f); Draw.delete(f.id); // persist props
  recalc(); refreshList();
});

// ===== CALC + LIST =====
function recalc(){
  const fc = Draw.getAll();
  let areaSqft = 0, lineM = 0;
  fc.features.forEach(f=>{
    if(f.geometry.type==='Polygon'){ areaSqft += turf.area(f)*10.7639; }
    if(f.geometry.type==='LineString'){ lineM += turf.length(f,{units:'kilometers'})*1000; }
  });
  const { base, ratePoly, rateLine } = currentRates();
  const total = base + areaSqft*ratePoly + lineM*rateLine;
  $('area').textContent = fmt(areaSqft);
  $('linear').textContent = fmt(lineM);
  $('total').textContent = '$'+fmt(total);
  refreshList();
}

function refreshList(){
  const list = $('shapeList'); list.innerHTML = '';
  const fc = Draw.getAll();
  fc.features.forEach(f=>{
    const id = f.id; const isPoly = f.geometry.type==='Polygon';
    const a = isPoly ? turf.area(f)*10.7639 : 0;
    const m = !isPoly ? turf.length(f,{units:'kilometers'})*1000 : 0;
    const label = (f.properties && f.properties.label) || (isPoly ? 'Area' : 'Edge');
    const row = document.createElement('div'); row.className='list-item';
    row.innerHTML = `
      <div><b>${label}</b> ‚Ä¢ ${isPoly ? fmt(a)+' sqft' : fmt(m)+' m'}</div>
      <div class="thumb-row">
        <button class="btn" data-act="select">Edit</button>
        <button class="btn danger" data-act="trash">Remove</button>
      </div>`;
    row.querySelector('[data-act="select"]').onclick = ()=>{ Draw.changeMode('simple_select', {featureIds:[id]}); $('labelSelect').value = (f.properties && f.properties.label) || ''; };
    row.querySelector('[data-act="trash"]').onclick = ()=>{ Draw.delete(id); recalc(); };
    list.appendChild(row);
  });
}

map.on('draw.create', ()=>{ recalc(); vib(10); });
map.on('draw.update', recalc);
map.on('draw.delete', recalc);

// ===== PRICING MODE =====
let MODE = 'lawn';
function currentRates(){
  return (MODE==='lawn')
    ? { base:+baseLawn.value||0, ratePoly:+rateLawnSqft.value||0, rateLine:+rateDriveM.value||0 }
    : { base:+baseSnow.value||0, ratePoly:+rateLotSqft.value||0, rateLine:+rateSidewalkM.value||0 };
}
$('modeLawn').onclick = ()=>{ MODE='lawn'; toggleModeUI(); recalc(); };
$('modeSnow').onclick = ()=>{ MODE='snow'; toggleModeUI(); recalc(); };
function toggleModeUI(){
  $('modeLawn').classList.toggle('active', MODE==='lawn');
  $('modeSnow').classList.toggle('active', MODE==='snow');
  $('pricingLawn').style.display = MODE==='lawn' ? 'grid' : 'none';
  $('pricingSnow').style.display = MODE==='snow' ? 'grid' : 'none';
}

// ===== SAVE (Supabase) =====
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
$('saveContinue').onclick = saveQuote;

async function saveQuote(){
  const btn = $('saveContinue');
  try{
    if(!ACCOUNT_ID){ alert('Missing ACCOUNT_ID'); return; }
    const addrText = (document.querySelector('.mapboxgl-ctrl-geocoder input')?.value || '').trim() || 'Unknown address';
    const fc = Draw.getAll();
    if(!fc.features.length){ alert('Draw at least one area or line.'); return; }

    // totals
    let areaSqft = 0, lineM = 0;
    fc.features.forEach(f=>{
      if(f.geometry.type==='Polygon'){ areaSqft += turf.area(f)*10.7639; }
      if(f.geometry.type==='LineString'){ lineM += turf.length(f,{units:'kilometers'})*1000; }
    });
    const { base, ratePoly, rateLine } = currentRates();
    const total = base + areaSqft*ratePoly + lineM*rateLine;

    btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

    // 1) property
    const c = map.getCenter();
    const { data: prop, error: propErr } = await supa
      .from('properties')
      .insert({ account_id: ACCOUNT_ID, address: addrText, lat: c.lat, lng: c.lng })
      .select().single();
    if(propErr) throw propErr;

    // 2) zones (ensure your DB has a `label` text column)
    const rows = fc.features.map(f=>{
      const isPoly = f.geometry.type==='Polygon';
      return {
        property_id: prop.id,
        kind: isPoly ? (MODE==='lawn' ? 'lawn' : 'lot_snow') : (MODE==='lawn' ? 'hardscape' : 'sidewalk_snow'),
        geojson: f,
        area_sqft: isPoly ? turf.area(f)*10.7639 : 0,
        length_m:  !isPoly ? turf.length(f,{units:'kilometers'})*1000 : 0,
        label: (f.properties && f.properties.label) || null
      };
    });

    if(rows.length){
      const { error: zErr } = await supa.from('zones').insert(rows);
      if(zErr) throw zErr;
    }

    // 3) quote
    const { data: quote, error: qErr } = await supa
      .from('quotes')
      .insert({
        account_id: ACCOUNT_ID,
        property_id: prop.id,
        base_fee: (MODE==='lawn' ? +baseLawn.value : +baseSnow.value) || 0,
        rate_lawn: (MODE==='lawn' ? +rateLawnSqft.value : +rateLotSqft.value) || 0,
        rate_drive: (MODE==='lawn' ? +rateDriveM.value : +rateSidewalkM.value) || 0,
        lawn_sqft: areaSqft,   // reuse for lot sqft in snow
        drive_m: lineM,       // reuse for sidewalk meters in snow
        total,
        status: MODE==='snow' ? 'sent_snow' : 'sent'
      })
      .select().single();
    if(qErr) throw qErr;

    window.location.href = `quote-review.html?quoteId=${quote.id}`;
  }catch(e){
    console.error('Save Quote failed:', e);
    alert('Save failed: ' + (e.message || e));
  }finally{
    btn.disabled=false; btn.textContent='Save & Continue';
  }
}

// Init
recalc();
</script>
</body>
</html>
