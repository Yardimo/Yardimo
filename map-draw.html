<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Yardimo ‚Ä¢ Map Draw</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet"/>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" rel="stylesheet"/>
<link rel="stylesheet" href="styles.css"/>
<style>
  :root{--panel:#0f1720;--muted:#1c2633;--text:#eaf2f6;--sub:#b8c5cf;--brand:#2dd4bf;--warn:#ffd447}
  body{background:#0b0f14;color:var(--text)}
  #map{height:65vh;border:1px solid var(--muted);border-radius:12px;overflow:hidden}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .toolbar .btn{padding:10px 14px}
  .seg{display:inline-flex;border:1px solid var(--muted);border-radius:999px;overflow:hidden}
  .seg button{padding:10px 14px;background:#0b0f14;border:0;color:var(--sub);cursor:pointer}
  .seg button.active{background:var(--brand);color:#04231f}
  .stack{display:grid;gap:8px}
  .list{margin-top:8px;border:1px solid var(--muted);border-radius:10px;max-height:180px;overflow:auto}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #12202c}
  .list-item:last-child{border-bottom:0}
  .list-item button{padding:4px 8px}
  .bottomBar{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(15,23,32,.1),rgba(15,23,32,.9));backdrop-filter:blur(6px);padding:12px;border-top:1px solid var(--muted)}
  .metrics{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .metrics .badge{font-size:15px}
  select,input{background:#0b0f14;color:var(--text);border:1px solid var(--muted);border-radius:8px;padding:8px}
  @media(max-width:980px){
    #map{height:70vh}
    .toolbar{gap:6px}
  }
  .hint{font-size:12px;color:var(--sub);margin-left:8px}
</style>
</head>
<body>
<header>
  <div class="wrap nav">
    <a href="index.html" class="btn" style="padding:6px 10px">üè∑Ô∏è Yardimo</a>
    <nav>
      <a href="index.html" style="color:#fff">Quotes</a>
      <a href="jobs.html">Jobs</a>
      <a href="crew.html">Crew</a>
      <a href="customers.html">Customers</a>
      <a href="pricing.html">Pricing</a>
      <a href="settings.html">Settings</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="panel">
    <h2>Draw & Quote</h2>

    <!-- Service toggle -->
    <div class="toolbar" style="justify-content:space-between;align-items:center">
      <div class="seg" role="tablist" aria-label="Service type">
        <button id="modeLawn" class="active" aria-pressed="true">Lawn Care</button>
        <button id="modeSnow" aria-pressed="false">Snow Removal</button>
      </div>
      <span class="hint">Polygon = areas (front/back yards, lots). Line = edges/sidewalks. Tap <b>Finish</b> to confirm.</span>
    </div>

    <!-- Address autocomplete -->
    <div id="geocoder" class="toolbar"></div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Drawing controls -->
    <div class="toolbar">
      <div class="seg" aria-label="Draw">
        <button id="btnArea">Add Area</button>
        <button id="btnEdge">Add Edge</button>
      </div>
      <button class="btn" id="btnFinish">Finish</button>
      <button class="btn" id="btnUndo">Undo</button>
      <button class="btn" id="btnDelete">Delete</button>

      <label style="margin-left:auto;display:flex;gap:6px;align-items:center">
        Label
        <select id="labelSelect">
          <option value="">(none)</option>
          <option>Front Yard</option>
          <option>Back Yard</option>
          <option>Side Yard</option>
          <option>Driveway</option>
          <option>Walkway</option>
          <option>Sidewalk</option>
          <option>Parking Lot</option>
          <option>Other</option>
        </select>
      </label>
    </div>

    <!-- Live metrics -->
    <div class="metrics">
      <span class="badge">Area: <b id="area">0</b> sqft</span>
      <span class="badge">Linear: <b id="linear">0</b> m</span>
      <span class="badge">Quote: <b id="total">$0.00</b></span>
    </div>

    <!-- Pricing -->
    <div class="stack" style="margin-top:10px">
      <div id="pricingLawn" class="stack">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label>Base $ <input id="baseLawn" type="number" step="0.01" value="15"></label>
          <label>$ / sqft lawn <input id="rateLawnSqft" type="number" step="0.0001" value="0.008"></label>
          <label>$ / m drive <input id="rateDriveM" type="number" step="0.01" value="0.8"></label>
        </div>
      </div>
      <div id="pricingSnow" class="stack" style="display:none">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <label>Base $ <input id="baseSnow" type="number" step="0.01" value="25"></label>
          <label>$ / sqft lot <input id="rateLotSqft" type="number" step="0.0001" value="0.010"></label>
          <label>$ / m sidewalk <input id="rateSidewalkM" type="number" step="0.01" value="1.2"></label>
        </div>
      </div>
    </div>

    <!-- Shapes list -->
    <div class="list" id="shapeList"></div>

    <!-- Sticky bottom action -->
    <div class="bottomBar">
      <div class="row" style="justify-content:flex-end">
        <button id="saveContinue" class="btn primary" onclick="saveQuote()">Save & Continue</button>
      </div>
    </div>
  </section>
</main>

<!-- Libraries -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  /* ===== CONFIG (use your real values) ===== */
mapboxgl.accessToken = 'pk.eyJ1IjoibWlrZW5vcnJpcyIsImEiOiJjbWU0eXIyMHQwb3NlMm1wcHNkYXRwYzYxIn0.HrNdh-cFPgqR4SSYgkdHTw';              // pk.xxxxxx
  const SUPABASE_URL = 'https://yikxwceipqtxjarcnxdr.supabase.co';                // https://xxxx.supabase.co
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlpa3h3Y2VpcHF0eGphcmNueGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NzkyMTIsImV4cCI6MjA3MDM1NTIxMn0.PmvRyNucXrOMXcwsXIWAaK6pfia0bzEXUw53cHEhFqI';      // anon key ONLY
  const ACCOUNT_ID = '0c3c69de-450c-4b76-91a7-cdc70d64ec9d';                  // from accounts table

  /* ===== MAP + CONTROLS ===== */
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/satellite-streets-v12',
    center:[-79.3832,43.6532], zoom:15
  });

  // Geocoder (autocomplete)
  const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker:false, placeholder:'Search address' });
  document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

  const Draw = new MapboxDraw({
    displayControlsDefault:false,
    controls:{ polygon:false, line_string:false, trash:false },
    styles:[
      {id:'gl-draw-polygon-fill',type:'fill',filter:['all',['==','$type','Polygon'],['!=','mode','static']],paint:{'fill-color':'#2dd4bf','fill-opacity':0.2}},
      {id:'gl-draw-polygon-stroke-active',type:'line',filter:['all',['==','$type','Polygon'],['!=','mode','static']],paint:{'line-color':'#2dd4bf','line-width':2}},
      {id:'gl-draw-line',type:'line',filter:['all',['==','$type','LineString'],['!=','mode','static']],paint:{'line-color':'#ffd447','line-width':3}}
    ]
  });
  map.addControl(Draw);
  map.addControl(new mapboxgl.NavigationControl());
  map.on('error', e => console.error('Mapbox error:', e?.error));

  // Mode & rates
  let MODE = 'lawn'; // 'lawn' | 'snow'
  function currentRates(){
    return (MODE==='lawn')
      ? { base:+baseLawn.value||0, ratePoly:+rateLawnSqft.value||0, rateLine:+rateDriveM.value||0 }
      : { base:+baseSnow.value||0, ratePoly:+rateLotSqft.value||0, rateLine:+rateSidewalkM.value||0 };
  }

  // Buttons
  const $ = id => document.getElementById(id);
  $('modeLawn').onclick = ()=>{ MODE='lawn'; $('modeLawn').classList.add('active'); $('modeSnow').classList.remove('active'); $('pricingLawn').style.display='grid'; $('pricingSnow').style.display='none'; recalc(); };
  $('modeSnow').onclick = ()=>{ MODE='snow'; $('modeSnow').classList.add('active'); $('modeLawn').classList.remove('active'); $('pricingLawn').style.display='none'; $('pricingSnow').style.display='grid'; recalc(); };
  $('btnArea').onclick = ()=> Draw.changeMode('draw_polygon');
  $('btnEdge').onclick = ()=> Draw.changeMode('draw_line_string');
  $('btnFinish').onclick = ()=> Draw.changeMode('simple_select');
  $('btnUndo').onclick = ()=> { const s = Draw.getSelectedIds(); if(s.length){ Draw.trash(); } else { const all = Draw.getAll().features; if(all.length){ Draw.delete(all[all.length-1].id);} } recalc(); };
  $('btnDelete').onclick = ()=> { const s = Draw.getSelectedIds(); if(s.length){ Draw.delete(s); } recalc(); };

  // Label selected feature
  $('labelSelect').addEventListener('change', ()=>{
    const sel = Draw.getSelected(); if(!sel.features.length) return;
    const f = sel.features[0]; f.properties = f.properties || {}; f.properties.label = $('labelSelect').value || '';
    Draw.add(f); Draw.delete(f.id); // replace to persist prop
    recalc(); refreshList();
  });

  // Geocoder fly
  geocoder.on('result', e => {
    const [lon,lat] = e.result.center;
    map.flyTo({center:[lon,lat],zoom:19});
  });

  /* ===== CALC & LIST ===== */
  function fmt(n){ return (Math.round(n*100)/100).toLocaleString(); }

  function recalc(){
    const fc = Draw.getAll();
    let areaSqft = 0, lineM = 0;
    fc.features.forEach(f=>{
      if(f.geometry.type==='Polygon'){ areaSqft += turf.area(f)*10.7639; }
      if(f.geometry.type==='LineString'){ lineM += turf.length(f,{units:'kilometers'})*1000; }
    });
    const { base, ratePoly, rateLine } = currentRates();
    const total = base + areaSqft*ratePoly + lineM*rateLine;
    $('area').textContent = fmt(areaSqft);
    $('linear').textContent = fmt(lineM);
    $('total').textContent = '$' + fmt(total);
    refreshList();
  }

  function refreshList(){
    const list = $('shapeList'); list.innerHTML = '';
    const fc = Draw.getAll();
    fc.features.forEach(f=>{
      const id = f.id;
      const isPoly = f.geometry.type==='Polygon';
      const a = isPoly ? turf.area(f)*10.7639 : 0;
      const m = !isPoly ? turf.length(f,{units:'kilometers'})*1000 : 0;
      const label = (f.properties && f.properties.label) || (isPoly ? 'Area' : 'Edge');
      const row = document.createElement('div');
      row.className='list-item';
      row.innerHTML = `
        <div><b>${label}</b> ‚Ä¢ ${isPoly ? fmt(a)+' sqft' : fmt(m)+' m'}</div>
        <div>
          <button class="btn" data-act="select">Edit</button>
          <button class="btn" data-act="trash">Remove</button>
        </div>`;
      row.querySelector('[data-act="select"]').onclick = ()=> { Draw.changeMode('simple_select', {featureIds:[id]}); $('labelSelect').value = (f.properties && f.properties.label) || ''; };
      row.querySelector('[data-act="trash"]').onclick = ()=> { Draw.delete(id); recalc(); };
      list.appendChild(row);
    });
  }

  map.on('draw.create', recalc);
  map.on('draw.update', recalc);
  map.on('draw.delete', recalc);
  ['baseLawn','rateLawnSqft','rateDriveM','baseSnow','rateLotSqft','rateSidewalkM'].forEach(id=>{
    const el=$(id); if(el) el.addEventListener('input', recalc);
  });

  /* ===== SUPABASE SAVE ===== */
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function saveQuote(){
    const btn = $('saveContinue') || {disabled:false, textContent:''};
    try{
      if(!ACCOUNT_ID){ alert('Missing ACCOUNT_ID'); return; }
      const addrText = (document.querySelector('.mapboxgl-ctrl-geocoder input')?.value || '').trim() || 'Unknown address';

      const fc = Draw.getAll();
      if(!fc.features.length){ alert('Draw at least one area or line.'); return; }

      // totals
      let areaSqft = 0, lineM = 0;
      fc.features.forEach(f=>{
        if(f.geometry.type==='Polygon'){ areaSqft += turf.area(f)*10.7639; }
        if(f.geometry.type==='LineString'){ lineM += turf.length(f,{units:'kilometers'})*1000; }
      });
      const { base, ratePoly, rateLine } = currentRates();
      const total = base + areaSqft*ratePoly + lineM*rateLine;

      btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

      // 1) property
      const c = map.getCenter();
      const { data: prop, error: propErr } = await supa
        .from('properties')
        .insert({ account_id: ACCOUNT_ID, address: addrText, lat: c.lat, lng: c.lng })
        .select().single();
      if(propErr) throw propErr;

      // 2) zones (preserve label in properties.label)
      const rows = fc.features.map(f=>{
        const isPoly = f.geometry.type==='Polygon';
        return {
          property_id: prop.id,
          kind: isPoly ? (MODE==='lawn' ? 'lawn' : 'lot_snow') : (MODE==='lawn' ? 'hardscape' : 'sidewalk_snow'),
          geojson: f,
          area_sqft: isPoly ? turf.area(f)*10.7639 : 0,
          length_m:  !isPoly ? turf.length(f,{units:'kilometers'})*1000 : 0,
          label: (f.properties && f.properties.label) || null
        };
      });

      // add "label" to zones if your table doesn't have it yet:
      // ALTER TABLE zones ADD COLUMN IF NOT EXISTS label text;

      if(rows.length){
        const { error: zErr } = await supa.from('zones').insert(rows);
        if(zErr) throw zErr;
      }

      // 3) quote
      const { data: quote, error: qErr } = await supa
        .from('quotes')
        .insert({
          account_id: ACCOUNT_ID,
          property_id: prop.id,
          base_fee: base,
          rate_lawn: ratePoly,   // poly rate (lawn or lot)
          rate_drive: rateLine,  // line rate (drive/sidewalk)
          lawn_sqft: areaSqft,   // reuse for lot sqft in snow mode
          drive_m: lineM,        // reuse for sidewalk meters in snow mode
          total,
          status: MODE==='snow' ? 'sent_snow' : 'sent'
        })
        .select().single();
      if(qErr) throw qErr;

      window.location.href = `quote-review.html?quoteId=${quote.id}`;
    }catch(e){
      console.error('Save Quote failed:', e);
      alert('Save failed: ' + (e.message || e));
    }finally{
      const b = $('saveContinue'); if(b){ b.disabled=false; b.textContent='Save & Continue'; }
    }
  }

  // initial
  recalc();
</script>
</body>
</html>
