<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Yardimo • Map Draw (v6.2c)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Mapbox Draw (stable) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.2/mapbox-gl-draw.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.2/mapbox-gl-draw.js"></script>

  <!-- Mapbox Geocoder (stable) -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <!-- Turf for measurement -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1720; --muted:#1c2633; --text:#eaf2f6; --sub:#b8c5cf;
      --brand:#2dd4bf; --warn:#ffd447; --danger:#f87171;
      --panel-h: clamp(200px, 33vh, 260px); /* mobile-friendly height */
    }
    @media (min-width:900px){ :root{ --panel-h: 150px; } }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Top toggle */
    .top{position:fixed;top:0;left:0;right:0;height:56px;z-index:10;display:flex;justify-content:center;align-items:center;gap:8px;background:#0f1720;border-bottom:1px solid var(--muted)}
    .toggle{border:1px solid var(--muted);padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--sub);background:#13212d}
    .toggle.active{background:var(--brand);color:#05221d;border-color:transparent;font-weight:600}

    /* Geocoder */
    #geocoder{position:fixed;top:64px;left:12px;right:12px;z-index:9}
    .mapboxgl-ctrl-geocoder{width:100%;max-width:720px;margin:0 auto}

    /* Map & panel */
    #map{position:absolute;top:112px;left:0;right:0;bottom:calc(var(--panel-h) + env(safe-area-inset-bottom))}
    .panel{
      position:fixed;left:0;right:0;bottom:0;height:var(--panel-h);z-index:8;
      background:linear-gradient(180deg,rgba(15,23,32,.65),rgba(15,23,32,.95));
      backdrop-filter:blur(6px);border-top:1px solid var(--muted);
      display:flex;gap:12px;align-items:flex-start;justify-content:center;flex-wrap:wrap;
      padding:12px; padding-bottom:calc(12px + env(safe-area-inset-bottom)); overflow:auto;
    }
    .box{border:1px solid var(--muted);border-radius:12px;padding:8px 10px;background:#0e141c;color:#b8c5cf}
    .box b{color:var(--text)}
    .btn{background:#16202b;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#05221d;border-color:transparent;font-weight:600}
    .btn.danger{background:#2a1616;color:#fee;border-color:#512}
    label{color:#b8c5cf;font-size:14px;display:flex;align-items:center;gap:6px}
    input{background:#0b0f14;color:var(--text);border:1px solid var(--muted);border-radius:8px;padding:8px 10px;width:140px}

    /* Error ribbon */
    #err{display:none;position:fixed;left:0;right:0;top:0;z-index:9999;background:#7f1d1d;color:#fff;padding:8px 10px;font-size:14px}
  </style>
</head>
<body>

<div id="err"></div>

<!-- Top bar -->
<div class="top" role="toolbar" aria-label="Service mode">
  <button id="lawnBtn" class="toggle active" aria-pressed="true" aria-label="Switch to Lawn Care">Lawn Care</button>
  <button id="snowBtn" class="toggle" aria-pressed="false" aria-label="Switch to Snow Removal">Snow Removal</button>
</div>

<!-- Geocoder & Map -->
<div id="geocoder"></div>
<div id="map" aria-label="Map drawing area"></div>

<!-- Bottom panel -->
<div class="panel">
  <div class="box" aria-live="polite">
    Lawn area: <b id="areaSqft">0</b> sqft (<span id="areaSqm">0</span> m²)
  </div>
  <div class="box" aria-live="polite">
    Edge length: <b id="lengthFt">0</b> ft (<span id="lengthM">0</span> m)
  </div>
  <div class="box" aria-live="polite">
    Estimated total: <b id="quoteTotal">$0.00</b>
    <div id="priceBreakdown" style="font-size:12px;color:#b8c5cf;margin-top:4px">Add an area or edge to calculate.</div>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <div id="lawnRates" style="display:flex;gap:10px;flex-wrap:wrap">
      <label>Base fee<input id="baseLawn" type="number" step="0.01" value="15"></label>
      <label>$ / sqft mowing<input id="rateLawnSqft" type="number" step="0.0001" value="0.008"></label>
      <label>$ / ft edge/drive<input id="rateDriveFt" type="number" step="0.01" value="0.80"></label>
    </div>
    <div id="snowRates" style="display:none;gap:10px;flex-wrap:wrap">
      <label>Base fee<input id="baseSnow" type="number" step="0.01" value="25"></label>
      <label>$ / sqft lot<input id="rateLotSqft" type="number" step="0.0001" value="0.010"></label>
      <label>$ / ft sidewalk<input id="rateSidewalkFt" type="number" step="0.01" value="0.80"></label>
    </div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <button class="btn" id="btnPoly" aria-label="Start Area">Start Area</button>
    <button class="btn" id="btnLine" aria-label="Start Edge">Start Edge</button>
    <button class="btn" id="btnFinish" aria-label="Finish Drawing">Finish</button>
    <button class="btn" id="btnUndo" aria-label="Undo last action">Undo</button>
    <button class="btn danger" id="btnClear" aria-label="Clear map">Clear</button>

    <!-- Label input for last finished shape -->
    <label style="display:flex;gap:6px;align-items:center">
      Label
      <input id="zoneLabel" placeholder="Front lawn / Driveway" />
    </label>

    <button class="btn primary" id="btnSave" aria-label="Save Estimate">Save estimate</button>
  </div>

  <!-- Context hint -->
  <div id="drawHint" style="width:100%;text-align:center;color:#b8c5cf;font-size:13px;margin-top:4px">
    Tap “Start Area”, then tap on the map to add points. Double-tap to finish.
  </div>
</div>

<script>
  /*
   * ====== Security note (Supabase RLS) ======
   * Using the anon key in the browser is OK only if Row Level Security is ON
   * and policies restrict writes to the current ACCOUNT_ID or user context.
   * Ensure 'properties', 'zones', and 'quotes' all have RLS enabled.
   */

  /* ========= Credentials (yours) ========= */
  mapboxgl.accessToken = 'pk.eyJ1IjoibWlrZW5vcnJpcyIsImEiOiJjbWU0eXIyMHQwb3NlMm1wcHNkYXRwYzYxIn0.HrNdh-cFPgqR4SSYgkdHTw';
  const SUPABASE_URL = 'https://yikxwceipqtxjarcnxdr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlpa3h3Y2VpcHF0eGphcmNueGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NzkyMTIsImV4cCI6MjA3MDM1NTIxMn0.PmvRyNucXrOMXcwsXIWAaK6pfia0bzEXUw53cHEhFqI';
  const ACCOUNT_ID = '0c3c69de-450c-4b76-91a7-cdc70d64ec9d';

  /* ========= Helpers & error UI ========= */
  const $ = id => document.getElementById(id);
  const fmt2 = n => (Math.round(n*100)/100).toLocaleString();
  const showErr = m => { const el=$('err'); el.textContent=m; el.style.display='block'; };

  /* ========= Map ========= */
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/satellite-streets-v12',
    center:[-81.2497,42.9836], zoom:16
  });
  map.addControl(new mapboxgl.NavigationControl());
  map.dragRotate.disable(); map.touchZoomRotate.disableRotation();
  map.once('load', ()=> map.resize());

  /* ========= Geocoder ========= */
  if (typeof MapboxGeocoder === 'undefined') showErr('Geocoder failed to load.');
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken, mapboxgl, marker:false,
    placeholder:'Search street address', flyTo:{zoom:19, speed:0.8}, countries:'ca,us'
  });
  $('geocoder').appendChild(geocoder.onAdd(map));
  let selectedAddress = '';
  geocoder.on('result', e => { selectedAddress = e.result.place_name || ''; });
  window.addEventListener('load', () => {
    const search = document.querySelector('.mapboxgl-ctrl-geocoder input');
    if (search) search.focus({ preventScroll:true });
  });

  /* ========= Draw (larger vertices) ========= */
  if (typeof MapboxDraw === 'undefined') showErr('Draw plugin failed to load.');
  const draw = new MapboxDraw({
    displayControlsDefault:false,
    controls:{ polygon:true, line_string:true, trash:true },
    styles:[
      // Polygons
      {id:'yd-poly-fill', type:'fill', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{'fill-color':'#2dd4bf','fill-opacity':0.22}},
      {id:'yd-poly-line', type:'line', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{'line-color':'#2dd4bf','line-width':3}},
      // Lines
      {id:'yd-line', type:'line', filter:['all',['==','$type','LineString'],['!=','mode','static']], paint:{'line-color':'#ffd447','line-width':4}},
      // Larger vertices (thumb targets)
      {id:'yd-pt-halo', type:'circle', filter:['all',['==','$type','Point'],['!=','meta','midpoint'],['!=','mode','static']], paint:{'circle-radius':10,'circle-color':'#000','circle-opacity':0.25}},
      {id:'yd-pt', type:'circle', filter:['all',['==','$type','Point'],['!=','meta','midpoint'],['!=','mode','static']], paint:{'circle-radius':6,'circle-color':'#2dd4bf','circle-stroke-color':'#05221d','circle-stroke-width':2}},
      {id:'yd-mid', type:'circle', filter:['all',['==','$type','Point'],['==','meta','midpoint']], paint:{'circle-radius':6,'circle-color':'#ffd447','circle-stroke-color':'#1c2633','circle-stroke-width':2}}
    ]
  });
  map.addControl(draw);

  /* ========= Interaction state while drawing ========= */
  let drawing = false;
  map.on('draw.modechange', e => {
    drawing = (e.mode==='draw_polygon' || e.mode==='draw_line_string');
    if (drawing) { map.doubleClickZoom.disable(); map.dragPan.disable(); }
    else { map.doubleClickZoom.enable(); map.dragPan.enable(); }
    setButtonsState(e.mode);
  });
  // Double-tap/Double-click to finish
  $('map').addEventListener('dblclick', () => { if (drawing) draw.changeMode('simple_select'); }, {passive:true});
  // ESC to cancel/finish drawing (keyboard)
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && drawing) draw.changeMode('simple_select'); });

  /* ========= Bottom buttons ========= */
  $('btnPoly').onclick = ()=> draw.changeMode('draw_polygon');
  $('btnLine').onclick = ()=> draw.changeMode('draw_line_string');
  $('btnFinish').onclick = ()=> draw.changeMode('simple_select');
  $('btnUndo').onclick = ()=>{
    const sel = draw.getSelectedIds();
    if(sel.length){ draw.trash(); }
    else { const all = draw.getAll().features; if(all.length) draw.delete(all[all.length-1].id); }
    scheduleRecalc();
  };
  $('btnClear').onclick = ()=> { draw.deleteAll(); scheduleRecalc(); };

  // Apply label to the last finished feature (if provided)
  function applyLabelToLast(label){
    if(!label) return;
    const fc = draw.getAll();
    const last = fc.features[fc.features.length-1];
    if(!last) return;
    last.properties = last.properties || {};
    last.properties.label = label;
    draw.add(last); draw.delete(last.id); // re-add to persist props
  }
  $('btnFinish').addEventListener('click', ()=>{
    const label = ($('zoneLabel').value || '').trim();
    applyLabelToLast(label);
  });
  $('map').addEventListener('dblclick', ()=>{
    const label = ($('zoneLabel').value || '').trim();
    applyLabelToLast(label);
  }, {passive:true});

  /* ========= Mode toggle & labels ========= */
  let mode = 'lawn'; // 'lawn' | 'snow'
  $('lawnBtn').onclick = ()=>{ mode='lawn'; setModeUI(); scheduleRecalc(); };
  $('snowBtn').onclick = ()=>{ mode='snow'; setModeUI(); scheduleRecalc(); };
  function setModeUI(){
    $('lawnBtn').classList.toggle('active', mode==='lawn');
    $('snowBtn').classList.toggle('active', mode==='snow');
    $('lawnBtn').setAttribute('aria-pressed', mode==='lawn');
    $('snowBtn').setAttribute('aria-pressed', mode==='snow');
    $('lawnRates').style.display = mode==='lawn' ? 'flex' : 'none';
    $('snowRates').style.display = mode==='snow' ? 'flex' : 'none';

    // Button copy per mode
    $('btnLine').textContent = (mode==='lawn') ? 'Start Edge' : 'Start Sidewalk';

    // Metric titles per mode
    document.querySelector('.panel .box:nth-child(1)').firstChild.textContent =
      (mode==='lawn') ? 'Lawn area: ' : 'Lot area: ';
    document.querySelector('.panel .box:nth-child(2)').firstChild.textContent =
      (mode==='lawn') ? 'Edge length: ' : 'Sidewalk length: ';
  }

  /* ========= Pricing ========= */
  const rateInputs = ['baseLawn','rateLawnSqft','rateDriveFt','baseSnow','rateLotSqft','rateSidewalkFt'];
  rateInputs.forEach(id=>{
    const el=$(id); if(!el) return;
    const key='yd_rate_'+id;
    const saved=localStorage.getItem(key);
    if(saved!==null) el.value=saved;
    el.addEventListener('input', ()=>localStorage.setItem(key, el.value));
    el.addEventListener('input', scheduleRecalc, {passive:true});
  });
  function currentRates(){
    return (mode==='lawn')
      ? { base:+$('baseLawn').value||0, rateSqft:+$('rateLawnSqft').value||0, rateFt:+$('rateDriveFt').value||0 }
      : { base:+$('baseSnow').value||0, rateSqft:+$('rateLotSqft').value||0, rateFt:+$('rateSidewalkFt').value||0 };
  }

  // rAF-debounced recalc
  let recalcRAF = null;
  function scheduleRecalc(){ if (recalcRAF) return; recalcRAF = requestAnimationFrame(()=>{ recalcRAF=null; recalc(); }); }

  function recalc(){
    const fc = draw.getAll();
    let areaSqm=0, lengthM=0;

    fc.features.forEach(f=>{
      if(f.geometry.type==='Polygon'){ areaSqm += turf.area(f); } // m²
      if(f.geometry.type==='LineString'){ lengthM += turf.length(f,{units:'kilometers'})*1000; } // m
    });

    // Convert for display + pricing
    const areaSqft = areaSqm * 10.7639;
    const lengthFt = lengthM * 3.28084;

    // Update metrics (dual units, Imperial first)
    $('areaSqft').textContent = fmt2(areaSqft);
    $('areaSqm').textContent  = fmt2(areaSqm);
    $('lengthFt').textContent = fmt2(lengthFt);
    $('lengthM').textContent  = fmt2(lengthM);

    const { base, rateSqft, rateFt } = currentRates();
    const rawTotal = base + areaSqft*rateSqft + lengthFt*rateFt;
    const rounded  = Math.round(rawTotal * 2) / 2; // nearest $0.50 for display

    $('quoteTotal').textContent = '$' + (Math.round(rounded*100)/100).toLocaleString();

    const parts = [];
    if (base) parts.push(`Base $${base.toFixed(2)}`);
    if (areaSqft && rateSqft) parts.push(`${Math.round(areaSqft).toLocaleString()} sqft × $${rateSqft}`);
    if (lengthFt && rateFt)   parts.push(`${Math.round(lengthFt).toLocaleString()} ft × $${rateFt}`);
    $('priceBreakdown').textContent = parts.length ? parts.join(' + ') : 'Add an area or edge to calculate.';

    // Buttons state
    setButtonsState();
  }

  function setButtonsState(modeName){
    const hasAny = draw.getAll().features.length > 0;
    const isDrawing = (modeName ? (modeName==='draw_polygon'||modeName==='draw_line_string') : drawing);
    $('btnFinish').disabled = !isDrawing;
    $('btnSave').disabled   = !hasAny;

    if (!isDrawing) {
      $('drawHint').textContent = 'Tap “Start Area”, then tap on the map to add points. Double-tap to finish.';
      $('btnFinish').textContent = 'Finish';
    } else if (modeName==='draw_polygon') {
      $('drawHint').textContent = 'Placing area points… Double-tap to finish the area.';
      $('btnFinish').textContent = 'Finish Area';
    } else if (modeName==='draw_line_string') {
      $('drawHint').textContent = (mode==='lawn')
        ? 'Placing edge points… Double-tap to finish the edge.'
        : 'Placing sidewalk points… Double-tap to finish the sidewalk.';
      $('btnFinish').textContent = (mode==='lawn') ? 'Finish Edge' : 'Finish Sidewalk';
    }
  }

  map.on('draw.create', scheduleRecalc);
  map.on('draw.update', scheduleRecalc);
  map.on('draw.delete', scheduleRecalc);

  /* ========= Save (Supabase) ========= */
  const supa = (SUPABASE_URL && SUPABASE_ANON_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
  $('btnSave').onclick = saveQuote;

  async function saveQuote(){
    try{
      if(!supa){ alert('Supabase not configured.'); return; }
      if(!ACCOUNT_ID){ alert('Missing ACCOUNT_ID.'); return; }

      const fc = draw.getAll();
      if(!fc.features.length){ alert('Draw at least one area or edge.'); return; }

      // totals (compute from geometry, not from DOM)
      let areaSqm=0, lengthM=0;
      fc.features.forEach(f=>{
        if(f.geometry.type==='Polygon')   areaSqm += turf.area(f);
        if(f.geometry.type==='LineString') lengthM += turf.length(f,{units:'kilometers'})*1000;
      });
      const areaSqft = areaSqm * 10.7639;
      const lengthFt = lengthM * 3.28084;
      const { base, rateSqft, rateFt } = currentRates();
      const total = base + areaSqft*rateSqft + lengthFt*rateFt; // priced in Imperial

      const addrText = selectedAddress || (document.querySelector('.mapboxgl-ctrl-geocoder input')?.value || 'Unknown address');

      // 1) property
      const c = map.getCenter();
      const { data: prop, error: propErr } = await supa
        .from('properties')
        .insert({ account_id: ACCOUNT_ID, address: addrText, lat: c.lat, lng: c.lng })
        .select().single();
      if(propErr) throw propErr;

      // 2) zones (store geometry + both units + label)
      const rows = fc.features.map(f=>{
        const isPoly = f.geometry.type==='Polygon';
        const zoneAreaSqm  = isPoly ? turf.area(f) : 0;
        const zoneAreaSqft = isPoly ? zoneAreaSqm * 10.7639 : 0;
        const zoneLenM     = !isPoly ? turf.length(f,{units:'kilometers'})*1000 : 0;
        const zoneLenFt    = !isPoly ? zoneLenM * 3.28084 : 0;
        return {
          property_id: prop.id,
          kind: isPoly ? (mode==='lawn' ? 'lawn' : 'lot_snow') : (mode==='lawn' ? 'hardscape' : 'sidewalk_snow'),
          geojson: f,
          area_sqft: zoneAreaSqft,
          area_sqm:  zoneAreaSqm,
          length_m:  zoneLenM,
          length_ft: zoneLenFt,
          label: (f.properties && f.properties.label) || null
        };
      });
      if(rows.length){
        const { error: zErr } = await supa.from('zones').insert(rows);
        if(zErr) throw zErr;
      }

      // 3) quote (store both systems too)
      const { data: quote, error: qErr } = await supa
        .from('quotes')
        .insert({
          account_id: ACCOUNT_ID,
          property_id: prop.id,
          base_fee: base,
          rate_sqft: rateSqft,   // Imperial area rate
          rate_ft:   rateFt,     // Imperial linear rate
          lawn_sqft: areaSqft,   // totals in Imperial
          drive_ft:  lengthFt,
          lawn_sqm:  areaSqm,    // and Metric
          drive_m:   lengthM,
          total,
          status: mode==='snow' ? 'sent_snow' : 'sent'
        })
        .select().single();
      if(qErr) throw qErr;

      alert('Saved! Quote #' + quote.id + ' • $' + (Math.round(total*100)/100).toLocaleString());
      // window.location.href = `quote-review.html?quoteId=${quote.id}`;
    }catch(err){
      console.error(err);
      alert('Save failed: ' + (err?.message || err));
    }
  }

  // Kickoff
  setModeUI();
  recalc();
</script>
</body>
</html>
