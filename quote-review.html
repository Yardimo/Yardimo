<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Yardimo ‚Ä¢ Quote Preview</title>
<link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="wrap nav">
    <a href="index.html" class="btn" style="padding:6px 10px">üè∑Ô∏è Yardimo</a>
    <nav>
      <a href="index.html">Quotes</a>
      <a href="jobs.html" style="color:#fff">Jobs</a>
      <a href="crew.html">Crew</a>
      <a href="customers.html">Customers</a>
      <a href="pricing.html">Pricing</a>
      <a href="settings.html">Settings</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="panel">
    <h2>Quote Preview</h2>
    <div id="qwrap" class="card">Loading‚Ä¶</div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  /* ====== CONFIG (EDIT) ====== */
  const SUPABASE_URL = 'https://yikxwceipqtxjarcnxdr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlpa3h3Y2VpcHF0eGphcmNueGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NzkyMTIsImV4cCI6MjA3MDM1NTIxMn0.PmvRyNucXrOMXcwsXIWAaK6pfia0bzEXUw53cHEhFqI';
  // Default schedule: tomorrow at 09:00 local
  const DEFAULT_SCHEDULE_ISO = (() => {
    const d = new Date(); d.setDate(d.getDate()+1); d.setHours(9,0,0,0); return d.toISOString();
  })();

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const el = (id)=>document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const quoteId = params.get('quoteId');

  function fmtCurrency(n){ return '$' + (Number(n||0).toFixed(2)); }

  async function loadQuote(){
    if(!quoteId){ el('qwrap').textContent='Missing quoteId'; return; }

    // Quote
    const { data: quote, error: qErr } = await supa
      .from('quotes')
      .select('id, total, base_fee, rate_lawn, rate_drive, lawn_sqft, drive_m, status, property_id, account_id, created_at')
      .eq('id', quoteId)
      .single();
    if(qErr){ el('qwrap').textContent='Error: '+qErr.message; return; }

    // Property
    const { data: prop } = await supa
      .from('properties')
      .select('id, address, lat, lng')
      .eq('id', quote.property_id)
      .single();

    // Zones (optional, for detail lines if you want)
    const { data: zones } = await supa
      .from('zones')
      .select('id, kind, area_sqft, length_m')
      .eq('property_id', quote.property_id);

    // Build table rows
    const lawnLineTotal = Number(quote.lawn_sqft||0) * Number(quote.rate_lawn||0);
    const driveLineTotal = Number(quote.drive_m||0)   * Number(quote.rate_drive||0);

    el('qwrap').innerHTML = `
      <h3>${prop?.address || 'Property'} ‚Äî Quote ${quote.id.slice(0,8)}</h3>
      <div class="note">Created: ${new Date(quote.created_at).toLocaleString()} ‚Ä¢ Status: ${quote.status}</div>
      <div class="hr"></div>
      <table class="table">
        <tr><th>Description</th><th>Qty</th><th>Rate</th><th>Total</th></tr>
        <tr>
          <td>Lawn mow (${(quote.lawn_sqft||0).toLocaleString()} sqft)</td>
          <td>1</td>
          <td>${fmtCurrency(quote.rate_lawn)}/sqft</td>
          <td>${fmtCurrency(lawnLineTotal)}</td>
        </tr>
        <tr>
          <td>Driveway/Hardscape (${(quote.drive_m||0).toLocaleString()} m)</td>
          <td>1</td>
          <td>${fmtCurrency(quote.rate_drive)}/m</td>
          <td>${fmtCurrency(driveLineTotal)}</td>
        </tr>
        <tr>
          <td>Base fee</td><td>1</td><td>‚Äî</td><td>${fmtCurrency(quote.base_fee)}</td>
        </tr>
        <tr><th colspan="3" style="text-align:right">Total</th><th>${fmtCurrency(quote.total)}</th></tr>
      </table>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="approveBtn">Approve & Create Job</button>
        <button class="btn" id="rejectBtn">Reject</button>
        <button class="btn" id="backBtn">Back</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label>Schedule at <input class="input" id="scheduleAt" type="datetime-local" /></label>
      </div>
    `;

    // set default schedule value (convert ISO to local 'YYYY-MM-DDTHH:mm')
    const dt = new Date(DEFAULT_SCHEDULE_ISO);
    const l = (n)=> String(n).padStart(2,'0');
    const local = `${dt.getFullYear()}-${l(dt.getMonth()+1)}-${l(dt.getDate())}T${l(dt.getHours())}:${l(dt.getMinutes())}`;
    document.getElementById('scheduleAt').value = local;

    document.getElementById('approveBtn').onclick = ()=> approveQuote(quote);
    document.getElementById('rejectBtn').onclick  = ()=> setStatus(quote.id,'rejected');
    document.getElementById('backBtn').onclick    = ()=> history.back();
  }

  async function setStatus(id, status){
    const { error } = await supa.from('quotes').update({ status }).eq('id', id);
    if(error){ alert('Failed to update status: '+error.message); return; }
    alert('Quote '+status+'.');
    if(status==='rejected'){ location.href='index.html'; }
  }

  async function approveQuote(quote){
    // 1) set quote to approved
    const { error: upErr } = await supa.from('quotes').update({ status:'approved' }).eq('id', quote.id);
    if(upErr){ alert('Failed to approve quote: '+upErr.message); return; }

    // 2) create job
    const iso = new Date(document.getElementById('scheduleAt').value).toISOString();
    const { error: jobErr } = await supa.from('jobs').insert({
      account_id: quote.account_id,
      property_id: quote.property_id,
      quote_id: quote.id,
      title: 'Service visit',
      scheduled_at: iso,
      status: 'scheduled'
    });
    if(jobErr){ alert('Job create failed: '+jobErr.message); return; }

    // 3) go to jobs
    location.href = 'jobs.html';
  }

  loadQuote();
</script>
</body>
</html>
